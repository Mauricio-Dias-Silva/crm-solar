{# produtos/templates/produtos/carrinho.html #}
{% extends 'produtos/base.html' %}
{% load static %}

{% block title %}Meu Carrinho{% endblock %}

{% block content %}
<div class="container my-4">
    <h2 class="text-center mb-5 display-5 fw-bold text-dark">Meu Carrinho</h2>

    {% if itens_carrinho %}
        <table class="table table-bordered table-hover">
            <thead class="table-dark">
                <tr>
                    <th scope="col">Produto</th>
                    <th scope="col">Preço Unitário</th>
                    <th scope="col">Quantidade</th>
                    <th scope="col">Subtotal</th>
                    <th scope="col">Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for item in itens_carrinho %}
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            {% if item.produto.images %}
                                {# Acessa a primeira imagem do produto real (objeto Produto) #}
                                {% with first_image=item.produto.images.first %}
                                {% if first_image %}
                                    <img src="{{ first_image.image.url }}" alt="{{ item.produto.name }}" class="img-thumbnail me-3" style="width: 80px; height: 80px; object-fit: cover;">
                                {% endif %}
                                {% endwith %}
                            {% endif %}
                            <a href="{% url 'produtos:produto_detalhe' item.produto.id %}" class="text-decoration-none text-dark fw-bold">{{ item.produto.name }}</a>
                        </div>
                    </td>
                    <td>R$ {{ item.produto.preco|floatformat:2 }}</td>
                    <td>{{ item.quantidade }}</td>
                    <td>R$ {{ item.subtotal|floatformat:2 }}</td>
                    <td>
                        {# Futuramente: botões para aumentar/diminuir quantidade ou remover item #}
                        <form action="{% url 'produtos:remover_do_carrinho' item.produto.id %}" method="POST" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-sm btn-outline-danger">Remover</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr>
                    <th colspan="3" class="text-end">Total do Carrinho:</th>
                    <th colspan="2">R$ {{ total_carrinho|floatformat:2 }}</th>
                </tr>
            </tfoot>
        </table>

        {# --- SEÇÃO PARA FINALIZAR COMPRA (AUTENTICADO OU CONVIDADO) --- #}
        {% if not request.user.is_authenticated %}
        {# Formulário para CONVIDADOS #}
        <div class="card mb-4">
            <div class="card-header">
                Detalhes para a Compra (Convidado)
            </div>
            <div class="card-body">
                <p>Por favor, informe seu e-mail para continuar a compra. Você não precisa se registrar.</p>
                <form method="POST" action="{% url 'pagamento:criar_checkout_session' %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="email_convidado" class="form-label">Seu E-mail:</label>
                        <input type="email" class="form-control" id="email_convidado" name="email" required placeholder="exemplo@dominio.com">
                    </div>
                    <div class="mb-3">
                        <label for="nome_convidado" class="form-label">Seu Nome (Opcional):</label>
                        <input type="text" class="form-control" id="nome_convidado" name="nome_convidado" placeholder="Nome Completo">
                    </div>
                    <button type="submit" class="btn btn-success w-100">Finalizar Compra</button>
                </form>
            </div>
        </div>
        {% else %}
        {# Formulário para USUÁRIOS AUTENTICADOS #}
        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
            <a href="{% url 'produtos:home' %}" class="btn btn-secondary me-md-2">Continuar Comprando</a>
            <form method="POST" action="{% url 'pagamento:criar_checkout_session' %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-success">Finalizar Compra ({{ request.user.email }})</button>
            </form>
        </div>
        {% endif %}

    {% else %}
        <div class="alert alert-info text-center" role="alert">
            Seu carrinho está vazio. <a href="{% url 'produtos:home' %}" class="alert-link">Comece a adicionar produtos!</a>
        </div>
    {% endif %}
</div>
{% endblock %}